# Minimal YAML for model evaluation

data: 
  # Data sources (supports joining multiple datasets)
  population: adsv       # Subject-level data
  observation: adlb      # Measurement-level data
  
# Data filtering
filter:
  - adsv.enrlfl == True
  - adlb.anafl == True

# Column mappings
columns:
  # Required identifiers
  subject_id: usubjid
  visit_id: visitid
  time: adt
  
  # Model evaluation columns
  ground_truth: aval
  estimates: [model1, model2]  # Multiple models
  
  # Grouping variables
  group: [trt01a, region]        # Hierarchical groups
  subgroup: [agegr1, sex, race]  # Marginal subgroups
  
  additional_variables: [var1, var2]

metrics:

  - name: "total_subject"         
    label: "Total Number of Subjects"
    type: across_samples
    shared_by: all              # Same value used for all models / group / subgroup.
    
  - name: "n_subject"
    label: "Number of Subjects"
    type: across_samples
    shared_by: model            # Same value used for all models
  
  - name: "n_visit"
    label: "Number of Visits"
    type: across_samples
    shared_by: model                

  - name: "n_sample"
    label: "Number of Samples"
    type: across_samples
    shared_by: model

  - name: "mae:mean"
    label: "Mean of per subject MAE"
    type: across_subject

  # an example of customized wegithed mean. 
  - name: "mae:wmean"
    label: "Weighted Mean of per subject MAE"
    type: across_subject
    agg:
      expr: 
        - mae  # Built-in metric shorthand (already has .alias("value"))
        - pl.col("weight").mean().alias("weight")
    select:
      expr: "(pl.col('value') * pl.col('weight')).sum() / pl.col('weight').sum()"

  - name: "mae"
    label: "MAE of each subject"
    type: within_subject

  - name: "rmse:mean" 
    label: "Mean of per visit RMSE"
    type: across_visit
  
  - name: "ae:pct_threshold" 
    label: "Percent of samples with absolute error < 1"
    type: across_samples
    select:
      expr: ((pl.col("absolute_error") < 1).mean() * 100).alias('value')
  

